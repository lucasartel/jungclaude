{% extends "base.html" %}

{% block content %}
<div class="space-y-8">

    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-white">Sistema TRI/IRT</h1>
            <p class="text-gray-400 mt-1">Item Response Theory - Avaliação Psicométrica Avançada</p>
        </div>
        <div class="flex gap-3">
            {% if tri_status == "not_migrated" %}
            <button onclick="runMigration()"
                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                Executar Migração
            </button>
            {% else %}
            <a href="/admin/master/dashboard"
                class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                Voltar ao Dashboard
            </a>
            {% endif %}
        </div>
    </div>

    {% if tri_status == "not_migrated" %}
    <!-- Status: Não Migrado -->
    <div class="rounded-xl p-8 text-center" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(139, 92, 246, 0.3);">
        <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center" style="background: rgba(139, 92, 246, 0.2);">
            <svg class="w-10 h-10 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
        </div>
        <h2 class="text-xl font-semibold text-white mb-2">Sistema TRI não migrado</h2>
        <p class="text-gray-400 mb-6 max-w-md mx-auto">
            As tabelas do sistema TRI ainda não foram criadas no banco de dados.
            Execute a migração para ativar o sistema de avaliação psicométrica avançada.
        </p>
        <button onclick="runMigration()"
            class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium">
            Executar Migração TRI
        </button>
    </div>

    {% else %}
    <!-- Status: Ativo -->

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Fragmentos Seed -->
        <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(139, 92, 246, 0.3);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Fragmentos Cadastrados</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ stats.total_fragments_seed or 0 }}</p>
                </div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(139, 92, 246, 0.2);">
                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">5 domínios × 6 facetas × 5 fragmentos</p>
        </div>

        <!-- Total Detecções -->
        <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(59, 130, 246, 0.3);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Detecções Realizadas</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ stats.total_detections or 0 }}</p>
                </div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(59, 130, 246, 0.2);">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">Fragmentos comportamentais identificados</p>
        </div>

        <!-- Usuários com Detecções -->
        <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(16, 185, 129, 0.3);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Usuários Perfilados</p>
                    <p class="text-3xl font-bold text-white mt-1">{{ stats.unique_users_with_detections or 0 }}</p>
                </div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(16, 185, 129, 0.2);">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">Com pelo menos 1 fragmento detectado</p>
        </div>

        <!-- Quality Checks -->
        <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(251, 191, 36, 0.3);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Quality Checks</p>
                    <p class="text-3xl font-bold text-white mt-1">
                        <span class="text-green-400">{{ stats.quality_checks_passed or 0 }}</span>
                        /
                        <span class="text-red-400">{{ stats.quality_checks_failed or 0 }}</span>
                    </p>
                </div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(251, 191, 36, 0.2);">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-2">Passed / Failed</p>
        </div>
    </div>

    <!-- Distribuição por Domínio -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gráfico de Pizza -->
        <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(139, 92, 246, 0.3);">
            <h3 class="text-lg font-semibold text-white mb-4">Distribuição por Domínio Big Five</h3>
            <div class="h-64">
                <canvas id="domainChart"></canvas>
            </div>
        </div>

        <!-- Lista de Domínios -->
        <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(139, 92, 246, 0.3);">
            <h3 class="text-lg font-semibold text-white mb-4">Detecções por Domínio</h3>
            <div class="space-y-4">
                {% for domain, count in (stats.by_domain or {}).items() %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full
                            {% if domain == 'extraversion' %}bg-red-400
                            {% elif domain == 'openness' %}bg-teal-400
                            {% elif domain == 'conscientiousness' %}bg-blue-400
                            {% elif domain == 'agreeableness' %}bg-green-400
                            {% else %}bg-yellow-400{% endif %}">
                        </div>
                        <span class="text-gray-300 capitalize">{{ domain }}</span>
                    </div>
                    <span class="text-white font-semibold">{{ count }}</span>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">Nenhuma detecção ainda</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Top Usuários -->
    <div class="rounded-xl p-6" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(139, 92, 246, 0.3);">
        <h3 class="text-lg font-semibold text-white mb-4">Top Usuários por Fragmentos Detectados</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-700">
                        <th class="text-left py-3 px-4 text-gray-400 font-medium">Usuário</th>
                        <th class="text-left py-3 px-4 text-gray-400 font-medium">User ID</th>
                        <th class="text-center py-3 px-4 text-gray-400 font-medium">Fragmentos</th>
                        <th class="text-center py-3 px-4 text-gray-400 font-medium">Intensidade Média</th>
                        <th class="text-center py-3 px-4 text-gray-400 font-medium">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in (stats.top_users or []) %}
                    <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                        <td class="py-3 px-4 text-white">{{ user.user_name }}</td>
                        <td class="py-3 px-4 text-gray-400 font-mono text-sm">{{ user.user_id[:12] }}...</td>
                        <td class="py-3 px-4 text-center">
                            <span class="px-3 py-1 rounded-full text-sm font-medium bg-purple-500/20 text-purple-300">
                                {{ user.fragment_count }}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center text-gray-300">{{ user.avg_intensity }}</td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="viewUserProfile('{{ user.user_id }}')"
                                class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors">
                                Ver Perfil TRI
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="py-8 text-center text-gray-500">
                            Nenhum usuário com detecções ainda
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endif %}
</div>

<script>
    {% if tri_status == "active" and stats and stats.by_domain %}
    // Gráfico de Distribuição por Domínio
    const domainData = {{ stats.by_domain | tojson | safe }};

    const colors = {
        'extraversion': '#FF6B6B',
        'openness': '#4ECDC4',
        'conscientiousness': '#45B7D1',
        'agreeableness': '#96CEB4',
        'neuroticism': '#FFEAA7'
    };

    const labels = Object.keys(domainData).map(d => d.charAt(0).toUpperCase() + d.slice(1));
    const values = Object.values(domainData);
    const backgroundColors = Object.keys(domainData).map(d => colors[d] || '#8B5CF6');

    new Chart(document.getElementById('domainChart'), {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: backgroundColors,
                borderColor: 'transparent',
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#94a3b8',
                        padding: 15,
                        font: { size: 12 }
                    }
                }
            }
        }
    });
    {% endif %}

    // Função para executar migração
    async function runMigration() {
        if (!confirm('Executar migração TRI? Isso criará 6 novas tabelas no banco de dados.')) {
            return;
        }

        try {
            const response = await fetch('/admin/irt/migration/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (response.ok) {
                alert('Migração executada com sucesso!');
                window.location.reload();
            } else {
                alert('Erro na migração: ' + (result.detail || result.message));
            }
        } catch (error) {
            alert('Erro: ' + error.message);
        }
    }

    // Função para ver perfil TRI de um usuário
    function viewUserProfile(userId) {
        // Por enquanto, abre em nova aba com JSON
        window.open('/admin/irt/user/' + userId, '_blank');
    }
</script>
{% endblock %}
