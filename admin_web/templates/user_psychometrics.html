{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">An√°lises Psicom√©tricas</h1>
            <p class="mt-1 text-sm text-gray-500">Perfil completo de {{ user.user_name or 'Usu√°rio' }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="/admin/user/{{ user_id }}/analysis" class="text-sm text-indigo-600 hover:text-indigo-500">
                ‚Üê Voltar para An√°lise MBTI
            </a>
            {% if not error %}
            <a
                href="/admin/user/{{ user_id }}/psychometrics/download-pdf"
                class="px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 inline-flex items-center"
                download
            >
                üì• Baixar PDF
            </a>
            {% endif %}
            <button
                hx-post="/admin/api/user/{{ user_id }}/regenerate-psychometrics"
                hx-target="#regenerate-result"
                class="px-4 py-2 bg-purple-600 text-white text-sm rounded-md hover:bg-purple-700"
            >
                üîÑ Regenerar An√°lises
            </button>
        </div>
    </div>

    <div id="regenerate-result"></div>

    <!-- Error State -->
    {% if error %}
    <div class="bg-red-50 border-l-4 border-red-400 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">Dados Insuficientes</h3>
                <div class="mt-2 text-sm text-red-700">
                    <p>{{ error }}</p>
                    <p class="mt-2">Total de conversas: {{ conversations_count }}</p>
                    <p>M√≠nimo necess√°rio: 20 conversas</p>
                </div>
            </div>
        </div>
    </div>
    {% else %}

    <!-- User Info Card -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center space-x-4">
            <div class="flex-shrink-0 h-16 w-16 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-2xl">
                {{ user.user_name[:2].upper() if user.user_name else 'U' }}
            </div>
            <div class="flex-1">
                <h2 class="text-xl font-semibold text-gray-900">{{ user.user_name or 'Usu√°rio' }}</h2>
                <p class="text-sm text-gray-500">ID: {{ user_id }}</p>
            </div>
            <div class="text-center px-4 border-l">
                <div class="text-3xl font-bold text-purple-600">{{ total_conversations }}</div>
                <div class="text-xs text-gray-500">Conversas Analisadas</div>
            </div>
            <div class="text-center px-4 border-l">
                <div class="text-lg font-semibold text-gray-700">v{{ psychometrics.version }}</div>
                <div class="text-xs text-gray-500">Vers√£o</div>
            </div>
            <div class="text-center px-4 border-l">
                <div class="text-sm text-gray-600">{{ psychometrics.analysis_date[:16] if psychometrics.analysis_date else 'N/A' }}</div>
                <div class="text-xs text-gray-500">Data da An√°lise</div>
            </div>
        </div>
    </div>

    <!-- Executive Summary -->
    {% if psychometrics.executive_summary %}
    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-purple-900 mb-3">üìä Resumo Executivo</h3>
        <div class="text-sm text-gray-700 space-y-2" id="executive-summary-content">
            <!-- Will be populated by JavaScript from JSON -->
        </div>
    </div>
    {% endif %}

    <!-- Big Five Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">üåü Big Five (OCEAN)</h3>
                    <p class="mt-1 text-sm text-gray-500">Tra√ßos fundamentais de personalidade</p>
                </div>
                {% if psychometrics.big_five_confidence %}
                <div class="text-right">
                    <div class="text-2xl font-bold text-indigo-600">{{ psychometrics.big_five_confidence }}%</div>
                    <div class="text-xs text-gray-500">Confian√ßa</div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart -->
                <div class="flex items-center justify-center">
                    <canvas id="bigFiveRadarChart" width="400" height="400"></canvas>
                </div>

                <!-- Details -->
                <div class="space-y-4">
                    <!-- Openness -->
                    <div class="border-l-4 border-blue-500 pl-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-900">Abertura (Openness)</h4>
                            <span class="text-2xl font-bold text-blue-600">{{ psychometrics.openness_score }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ psychometrics.openness_level }}</p>
                        <p class="text-xs text-gray-500 mt-2">{{ psychometrics.openness_description }}</p>
                        <button
                            onclick="showEvidence('openness')"
                            class="mt-2 text-xs text-blue-600 hover:text-blue-800 font-medium"
                        >
                            üîç Ver Evid√™ncias
                        </button>
                    </div>

                    <!-- Conscientiousness -->
                    <div class="border-l-4 border-green-500 pl-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-900">Conscienciosidade (Conscientiousness)</h4>
                            <span class="text-2xl font-bold text-green-600">{{ psychometrics.conscientiousness_score }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ psychometrics.conscientiousness_level }}</p>
                        <p class="text-xs text-gray-500 mt-2">{{ psychometrics.conscientiousness_description }}</p>
                        <button
                            onclick="showEvidence('conscientiousness')"
                            class="mt-2 text-xs text-green-600 hover:text-green-800 font-medium"
                        >
                            üîç Ver Evid√™ncias
                        </button>
                    </div>

                    <!-- Extraversion -->
                    <div class="border-l-4 border-yellow-500 pl-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-900">Extrovers√£o (Extraversion)</h4>
                            <span class="text-2xl font-bold text-yellow-600">{{ psychometrics.extraversion_score }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ psychometrics.extraversion_level }}</p>
                        <p class="text-xs text-gray-500 mt-2">{{ psychometrics.extraversion_description }}</p>
                        <button
                            onclick="showEvidence('extraversion')"
                            class="mt-2 text-xs text-yellow-600 hover:text-yellow-800 font-medium"
                        >
                            üîç Ver Evid√™ncias
                        </button>
                    </div>

                    <!-- Agreeableness -->
                    <div class="border-l-4 border-pink-500 pl-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-900">Amabilidade (Agreeableness)</h4>
                            <span class="text-2xl font-bold text-pink-600">{{ psychometrics.agreeableness_score }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ psychometrics.agreeableness_level }}</p>
                        <p class="text-xs text-gray-500 mt-2">{{ psychometrics.agreeableness_description }}</p>
                        <button
                            onclick="showEvidence('agreeableness')"
                            class="mt-2 text-xs text-pink-600 hover:text-pink-800 font-medium"
                        >
                            üîç Ver Evid√™ncias
                        </button>
                    </div>

                    <!-- Neuroticism -->
                    <div class="border-l-4 border-red-500 pl-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-900">Neuroticismo (Neuroticism)</h4>
                            <span class="text-2xl font-bold text-red-600">{{ psychometrics.neuroticism_score }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ psychometrics.neuroticism_level }}</p>
                        <p class="text-xs text-gray-500 mt-2">{{ psychometrics.neuroticism_description }}</p>
                        <button
                            onclick="showEvidence('neuroticism')"
                            class="mt-2 text-xs text-red-600 hover:text-red-800 font-medium"
                        >
                            üîç Ver Evid√™ncias
                        </button>
                    </div>
                </div>
            </div>

            {% if psychometrics.big_five_interpretation %}
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h4 class="font-semibold text-gray-900 mb-2">üí° Interpreta√ß√£o Integrada</h4>
                <p class="text-sm text-gray-700">{{ psychometrics.big_five_interpretation }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Emotional Intelligence Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">üíô Intelig√™ncia Emocional (EQ)</h3>
                    <p class="mt-1 text-sm text-gray-500">Capacidade de perceber e gerenciar emo√ß√µes</p>
                </div>
                {% if psychometrics.eq_overall %}
                <div class="text-right">
                    <div class="text-3xl font-bold text-blue-600">{{ psychometrics.eq_overall }}</div>
                    <div class="text-xs text-gray-500">Score Geral</div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Self-Awareness -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-700">{{ psychometrics.eq_self_awareness }}</div>
                    <div class="text-sm font-medium text-blue-900 mt-2">Autoconsci√™ncia</div>
                    <div class="text-xs text-blue-600 mt-1">Conhecer suas emo√ß√µes</div>
                </div>

                <!-- Self-Management -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-700">{{ psychometrics.eq_self_management }}</div>
                    <div class="text-sm font-medium text-green-900 mt-2">Autogest√£o</div>
                    <div class="text-xs text-green-600 mt-1">Controlar rea√ß√µes</div>
                </div>

                <!-- Social Awareness -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-purple-700">{{ psychometrics.eq_social_awareness }}</div>
                    <div class="text-sm font-medium text-purple-900 mt-2">Consci√™ncia Social</div>
                    <div class="text-xs text-purple-600 mt-1">Empatia e percep√ß√£o</div>
                </div>

                <!-- Relationship Management -->
                <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-pink-700">{{ psychometrics.eq_relationship_management }}</div>
                    <div class="text-sm font-medium text-pink-900 mt-2">Gest√£o de Relacionamentos</div>
                    <div class="text-xs text-pink-600 mt-1">Influ√™ncia e colabora√ß√£o</div>
                </div>
            </div>

            {% if psychometrics.eq_leadership_potential %}
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                <h4 class="font-semibold text-indigo-900 mb-2">üëî Potencial de Lideran√ßa</h4>
                <p class="text-sm text-indigo-800">{{ psychometrics.eq_leadership_potential }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- VARK Learning Style Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">üìö Estilo de Aprendizagem (VARK)</h3>
                    <p class="mt-1 text-sm text-gray-500">Prefer√™ncias de absor√ß√£o de conhecimento</p>
                </div>
                {% if psychometrics.vark_dominant %}
                <div class="text-right">
                    <div class="text-xl font-bold text-purple-600">{{ psychometrics.vark_dominant }}</div>
                    <div class="text-xs text-gray-500">Estilo Dominante</div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart -->
                <div class="flex items-center justify-center">
                    <canvas id="varkBarChart" width="400" height="300"></canvas>
                </div>

                <!-- Details -->
                <div class="space-y-4">
                    <!-- Visual -->
                    <div class="flex items-center">
                        <div class="w-32 font-semibold text-gray-900">üëÅÔ∏è Visual</div>
                        <div class="flex-1">
                            <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
                                <div class="bg-blue-500 h-6 flex items-center justify-center text-white text-xs font-bold" style="width: {{ psychometrics.vark_visual }}%">
                                    {{ psychometrics.vark_visual }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Auditory -->
                    <div class="flex items-center">
                        <div class="w-32 font-semibold text-gray-900">üéß Auditivo</div>
                        <div class="flex-1">
                            <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
                                <div class="bg-green-500 h-6 flex items-center justify-center text-white text-xs font-bold" style="width: {{ psychometrics.vark_auditory }}%">
                                    {{ psychometrics.vark_auditory }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reading/Writing -->
                    <div class="flex items-center">
                        <div class="w-32 font-semibold text-gray-900">üìñ Leitura</div>
                        <div class="flex-1">
                            <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
                                <div class="bg-yellow-500 h-6 flex items-center justify-center text-white text-xs font-bold" style="width: {{ psychometrics.vark_reading }}%">
                                    {{ psychometrics.vark_reading }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kinesthetic -->
                    <div class="flex items-center">
                        <div class="w-32 font-semibold text-gray-900">‚úã Cinest√©sico</div>
                        <div class="flex-1">
                            <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
                                <div class="bg-red-500 h-6 flex items-center justify-center text-white text-xs font-bold" style="width: {{ psychometrics.vark_kinesthetic }}%">
                                    {{ psychometrics.vark_kinesthetic }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if psychometrics.vark_recommended_training %}
                    <div class="mt-6 bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h4 class="font-semibold text-purple-900 mb-2">üéØ Recomenda√ß√£o de Treinamento</h4>
                        <p class="text-sm text-purple-800">{{ psychometrics.vark_recommended_training }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Schwartz Values Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-6 py-5 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">üéØ Valores Pessoais (Schwartz)</h3>
                    <p class="mt-1 text-sm text-gray-500">10 valores universais e motiva√ß√µes</p>
                </div>
                {% if psychometrics.schwartz_top_3 %}
                <div class="text-right">
                    <div class="text-sm font-semibold text-indigo-600">{{ psychometrics.schwartz_top_3 }}</div>
                    <div class="text-xs text-gray-500">Top 3 Valores</div>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="schwartz-values-grid">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                {% if psychometrics.schwartz_cultural_fit %}
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 mb-2">üè¢ Fit Cultural</h4>
                    <p class="text-sm text-green-800">{{ psychometrics.schwartz_cultural_fit }}</p>
                </div>
                {% endif %}

                {% if psychometrics.schwartz_retention_risk %}
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h4 class="font-semibold text-yellow-900 mb-2">‚ö†Ô∏è Risco de Reten√ß√£o</h4>
                    <p class="text-sm text-yellow-800">{{ psychometrics.schwartz_retention_risk }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if not error and psychometrics %}

    // ========== BIG FIVE RADAR CHART ==========
    const bigFiveCtx = document.getElementById('bigFiveRadarChart');
    if (bigFiveCtx) {
        new Chart(bigFiveCtx, {
            type: 'radar',
            data: {
                labels: ['Abertura', 'Conscienciosidade', 'Extrovers√£o', 'Amabilidade', 'Neuroticismo'],
                datasets: [{
                    label: 'Big Five Score',
                    data: [
                        {{ psychometrics.openness_score or 0 }},
                        {{ psychometrics.conscientiousness_score or 0 }},
                        {{ psychometrics.extraversion_score or 0 }},
                        {{ psychometrics.agreeableness_score or 0 }},
                        {{ psychometrics.neuroticism_score or 0 }}
                    ],
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                }]
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // ========== VARK BAR CHART ==========
    const varkCtx = document.getElementById('varkBarChart');
    if (varkCtx) {
        new Chart(varkCtx, {
            type: 'bar',
            data: {
                labels: ['Visual', 'Auditivo', 'Leitura', 'Cinest√©sico'],
                datasets: [{
                    label: 'VARK Score',
                    data: [
                        {{ psychometrics.vark_visual or 0 }},
                        {{ psychometrics.vark_auditory or 0 }},
                        {{ psychometrics.vark_reading or 0 }},
                        {{ psychometrics.vark_kinesthetic or 0 }}
                    ],
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(234, 179, 8, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(34, 197, 94, 1)',
                        'rgba(234, 179, 8, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // ========== SCHWARTZ VALUES GRID ==========
    const schwartzGrid = document.getElementById('schwartz-values-grid');
    if (schwartzGrid) {
        const schwartzValues = {{ schwartz_values | tojson }};

        const valueIcons = {
            'self_direction': 'üéØ',
            'stimulation': '‚ö°',
            'hedonism': 'üòä',
            'achievement': 'üèÜ',
            'power': 'üëë',
            'security': 'üõ°Ô∏è',
            'conformity': 'üìè',
            'tradition': 'üèõÔ∏è',
            'benevolence': '‚ù§Ô∏è',
            'universalism': 'üåç'
        };

        const valueNames = {
            'self_direction': 'Autodire√ß√£o',
            'stimulation': 'Estimula√ß√£o',
            'hedonism': 'Hedonismo',
            'achievement': 'Realiza√ß√£o',
            'power': 'Poder',
            'security': 'Seguran√ßa',
            'conformity': 'Conformidade',
            'tradition': 'Tradi√ß√£o',
            'benevolence': 'Benevol√™ncia',
            'universalism': 'Universalismo'
        };

        for (const [key, score] of Object.entries(schwartzValues)) {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 text-center';

            card.innerHTML = `
                <div class="text-3xl mb-2">${valueIcons[key] || '‚≠ê'}</div>
                <div class="font-semibold text-gray-900 mb-1">${valueNames[key] || key}</div>
                <div class="text-2xl font-bold text-indigo-600">${score}/100</div>
            `;

            schwartzGrid.appendChild(card);
        }
    }

    // ========== EXECUTIVE SUMMARY ==========
    const summaryDiv = document.getElementById('executive-summary-content');
    if (summaryDiv) {
        try {
            const summary = {{ psychometrics.executive_summary | tojson }};
            const summaryObj = typeof summary === 'string' ? JSON.parse(summary) : summary;

            let html = '';
            for (const [key, value] of Object.entries(summaryObj)) {
                html += `<div><strong>${key}:</strong> ${value}</div>`;
            }
            summaryDiv.innerHTML = html;
        } catch (e) {
            summaryDiv.innerHTML = '<p class="text-gray-600">Resumo n√£o dispon√≠vel</p>';
        }
    }

    {% endif %}

    // Evidence Modal Functions
    function showEvidence(dimension) {
        const modal = document.getElementById('evidenceModal');
        const modalTitle = document.getElementById('evidenceModalTitle');
        const modalContent = document.getElementById('evidenceModalContent');

        // Dimension names mapping
        const dimensionNames = {
            'openness': 'Abertura (Openness)',
            'conscientiousness': 'Conscienciosidade (Conscientiousness)',
            'extraversion': 'Extrovers√£o (Extraversion)',
            'agreeableness': 'Amabilidade (Agreeableness)',
            'neuroticism': 'Neuroticismo (Neuroticism)'
        };

        // Show modal and loading state
        modal.classList.remove('hidden');
        modalTitle.textContent = dimensionNames[dimension] || dimension;
        modalContent.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <span class="ml-3 text-gray-600">Carregando evid√™ncias...</span>
            </div>
        `;

        // Fetch evidence from API
        const userId = '{{ user_id }}';
        fetch(`/admin/user/${userId}/psychometrics/${dimension}/evidence`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch evidence');
                }
                return response.json();
            })
            .then(data => {
                displayEvidence(data);
            })
            .catch(error => {
                console.error('Error fetching evidence:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-600 font-semibold">Erro ao carregar evid√™ncias</p>
                        <p class="text-gray-600 text-sm mt-2">${error.message}</p>
                        <button onclick="closeEvidenceModal()" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            Fechar
                        </button>
                    </div>
                `;
            });
    }

    function displayEvidence(data) {
        const modalContent = document.getElementById('evidenceModalContent');

        if (!data.evidence || data.evidence.length === 0) {
            modalContent.innerHTML = `
                <div class="text-center py-12">
                    <p class="text-gray-600 font-semibold">Nenhuma evid√™ncia encontrada</p>
                    <p class="text-gray-500 text-sm mt-2">Esta dimens√£o ainda n√£o possui evid√™ncias extra√≠das das conversas.</p>
                </div>
            `;
            return;
        }

        // Build evidence cards HTML
        let html = `
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-sm font-semibold text-gray-700">Score:</span>
                        <span class="text-2xl font-bold text-blue-600 ml-2">${data.score}</span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">
                            ${data.evidence.length} evid√™ncia(s) encontrada(s)
                        </div>
                        ${data.extraction_cached ? '<div class="text-xs text-green-600 mt-1">‚úì Cache</div>' : '<div class="text-xs text-blue-600 mt-1">‚Ä¢ Extra√≠do agora</div>'}
                    </div>
                </div>
            </div>

            <div class="space-y-4 max-h-96 overflow-y-auto">
        `;

        data.evidence.forEach((evidence, index) => {
            const directionColor = evidence.direction === 'positive' ? 'green' : evidence.direction === 'negative' ? 'red' : 'gray';
            const directionIcon = evidence.direction === 'positive' ? '‚Üë' : evidence.direction === 'negative' ? '‚Üì' : '‚Ä¢';
            const relevancePercent = Math.round(evidence.relevance_score * 100);
            const confidencePercent = Math.round(evidence.confidence * 100);

            html += `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-${directionColor}-600 font-bold text-xl">${directionIcon}</span>
                            <span class="text-xs font-semibold text-${directionColor}-600 uppercase">${evidence.direction}</span>
                            ${evidence.trait_indicator ? `<span class="text-xs text-gray-500">‚Ä¢ ${evidence.trait_indicator}</span>` : ''}
                        </div>
                        <a href="/admin/conversation/${evidence.conversation_id}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800">
                            Ver conversa ‚Üí
                        </a>
                    </div>

                    <div class="bg-gray-50 border-l-4 border-${directionColor}-400 p-3 mb-3">
                        <p class="text-sm text-gray-800 italic">"${evidence.quote}"</p>
                    </div>

                    ${evidence.context_before || evidence.context_after ? `
                        <div class="text-xs text-gray-600 mb-3">
                            ${evidence.context_before ? `<p class="mb-1"><strong>Antes:</strong> ${evidence.context_before}</p>` : ''}
                            ${evidence.context_after ? `<p><strong>Depois:</strong> ${evidence.context_after}</p>` : ''}
                        </div>
                    ` : ''}

                    ${evidence.explanation ? `
                        <div class="bg-blue-50 p-2 rounded text-xs text-gray-700 mb-3">
                            <strong>An√°lise:</strong> ${evidence.explanation}
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <div class="flex items-center space-x-4">
                            <span>
                                <strong>Relev√¢ncia:</strong>
                                <span class="font-semibold text-blue-600">${relevancePercent}%</span>
                            </span>
                            <span>
                                <strong>Confian√ßa:</strong>
                                <span class="font-semibold text-green-600">${confidencePercent}%</span>
                            </span>
                        </div>
                        <span class="text-gray-400">
                            ${new Date(evidence.conversation_timestamp).toLocaleDateString('pt-BR')}
                        </span>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        modalContent.innerHTML = html;
    }

    function closeEvidenceModal() {
        const modal = document.getElementById('evidenceModal');
        modal.classList.add('hidden');
    }
});
</script>

<!-- Evidence Modal -->
<div id="evidenceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
        <div class="flex items-center justify-between border-b pb-3 mb-4">
            <h3 id="evidenceModalTitle" class="text-xl font-bold text-gray-900">Evid√™ncias</h3>
            <button onclick="closeEvidenceModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                &times;
            </button>
        </div>
        <div id="evidenceModalContent">
            <!-- Content will be loaded here -->
        </div>
        <div class="mt-4 text-right">
            <button onclick="closeEvidenceModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                Fechar
            </button>
        </div>
    </div>
</div>

{% endblock %}
